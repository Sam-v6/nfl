name: pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-model-training-and-prediction-generation:
    # Only run on:
    # - push
    # - PRs where the branch lives in this repo (not a fork)
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.head.repo.full_name == github.repository)
    
    # Self hosted runner
    runs-on: [self-hosted]

    # The runner is self hosted on my machine, so this data path will be guaranteed to have this data path
    env:
      CI_DATA_ROOT: /home/sam/repos/hobby-repos/nfl/data/parquet

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Sync uv
        run: uv sync --locked
          
      - name: Test feature creation
        run: uv run src/create_features.py --profile

        # This will output model_params.json (--ci only runs 5 epochs for a single trial)
      - name: Test ray hyperparameter tuning
        run: uv run src/train_transformer.py --tune --ci

        # This will use model_params.json to create transformer.pt (--ci only runs 5 epochs)
      - name: Test transformer training
        run: uv run src/train_transformer.py --profile --ci

        # This will use transformer.pt for inference, will make predictions for all of week 9
      - name: Test prediction generation
        run: uv run src/generate_predictions.py --profile

        # This will use the predictions saved as parquet in stage above, only 1 plot, one animated play, and one confusion matrix is created
      - name: Post process predictions
        run: uv run src/process_predictions.py --profile --ci